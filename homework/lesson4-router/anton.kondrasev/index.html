<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User-list</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 60px;
        }
        .red {
            background-color: #990000;
            color: white;
        }

        .red .panel-heading, .red .panel-footer {
            background-color: #550000;
            color: #fff;
        }
    </style>
</head>
<body ng-app="routerExample">

<app-root></app-root>

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.1/angular.min.js"></script>
<script src="https://unpkg.com/angular-ui-router@1.0.3/release/angular-ui-router.min.js"></script>


<script>
    'use strict';
    const app = angular.module('routerExample', ['ui.router']);

    app.config(($stateProvider) => {
        $stateProvider.state({
            name: 'home',
            url: '/',
            template: '<home></home>',
        });

        $stateProvider.state({
            name: 'userList',
            url: '/user-list',
            template: '<user-list></user-list>',
            controllerAs: '$ctrl'
        });

        $stateProvider.state({
            name: 'mailList',
            url: '/mail-list',
            template: '<mail-box></mail-box>',
            controllerAs: '$ctrl'
        });
    });


    app.service("userService", function ($http) {
        this.getUsers = function () {
            return $http.get("https://learn.javascript.ru/courses/groups/api/participants?key=uczue3");
        }
    });

    app.component('appRoot', {
        templateUrl: "app-root.html"
    });

    app.component('home', {
        restrict: 'E',
        template: "<div>HOME state</div>"
    });

    /////////users list
    app.component('userList', {
        restrict: 'E',
        templateUrl: 'user-list.html',
        controller: function (userService) {
            userService.getUsers().then((response) => {
                this.users = response.data;
            })
        }
    });

    app.component('userCard', {
        restrict: 'E',
        bindings: {
            user: '<'
        },
        templateUrl: 'user-card.html',
        controller: function () {
            const self = this;
            this.onClick = () => self.selected = !self.selected;
        }
    });

    app.component('avatar', {
        restrict: 'E',
        bindings: {
            img: '<'
        },
        templateUrl: 'avatar.html'
    });

    //////////mail box
    app.component('mailBox', {
        bindings: {
            display: '@'
        },
        templateUrl: 'mail-box.html',
        controller: function ($scope) {
            this.letters = [
                {
                    id: 1,
                    title: "Letter #1",
                    content: "text"
                }, {
                    id: 2,
                    title: "Letter #2",
                    content: "text text"
                }];

            this.deleteLetter = (letter) => {
                this.letters = this.letters.filter(function (el) {
                    return el.id !== letter.id
                });
            };

            this.addLetter = () => {
                let randomId = Math.floor(Math.random() * 99 + 1);
                this.letters.push({
                    id: randomId,
                    content: "Random content - " + randomId,
                    title: "Random title #" + randomId
                });
                $scope.$apply();

                clearTimeout(this.timer);
                this.timer = generateTimeout(this.addLetter);
            };

            this.timer = generateTimeout(this.addLetter);
        }
    });

    app.component('mailLetter', {
        bindings: {
            letter: '<',
            onDeleteClicked: "&"
        },
        templateUrl: 'mail-letter.html',
        controller: function () {
            this.$onInit = () => {
                this.timeLived = 0;
                this.interval = setInterval(() => {
                    this.timeLived++;
                }, 1000);
            };

            this.$onDestroy = () => {
                clearInterval(this.interval);
                console.log(this.letter.title, this.timeLived);
            }
        }
    });


    function generateTimeout(handler) {
        let randomInterval = Math.floor(Math.random() * (8 - 3)) + 3;
        return setTimeout(handler, randomInterval * 1000);
    }
</script>
</body>
</html>